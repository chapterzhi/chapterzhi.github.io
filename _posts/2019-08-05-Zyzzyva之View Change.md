---
title: Zyzzyva之View Change
date: 2019-08-05 9:10:24
categories:
- zyzzyva
tags: 
- zyzzyva
---

## 视图变化 View Changes
视图变化要能选择一个新的主节点并保证任何好客户端中已经完成的历史不被改变。之前的一些协议中，需要一个正确的副本提交一个视图变化从而停止接受除了CHECKPOINT,VIEW-CHANGE和NEW-VIEW消息以外的消息。同时，为了防止坏节点扰乱系统，除非一个好副本提交一个视图变化，不然主节点不应改变。因此，一个好的副本只会在两种情况下提交视图变化，(1) 它观测到了主节点的错误，(2) 它有一个证明，证明有 f + 1 个副本提交了视图变化。  

Zyzzyva视图变化子协议和传统的视图变化子协议很相似除了有两点关键例外。第一，传统的视图变化协议一点怀疑主节点有错误就提交视图变化，而Zyzzyva中只有当副本知道其他正确副本会加入他们进行新主节点选举时才会提交一个视图变化。第二，Zyzzyva弱化了一个请求出现在新的视图历史中的条件。  
### VC1. 副本通过给其他副本们发送一个对主节点的控诉初始一个视图变化
副本通过给其他主节点发送一个<I-HATE-THE-PRIMAEY,v><sub>σ<sub>i</sub></sub>,表示了副本对主节点的行为不满意。在之前的协议中，这条消息代表副本 i 将不再参与当前的视图。在Zyzzyva中，这条消息只表示 i 会想要一个视图变化。即使发送了这个消息，i 还是会继续忠实的参与当前的视图。
### VC2. 副本接收到 f + 1 个对主节点错误的控诉，就提交一个视图变化
副本 i 通过发送一个对当前主节点的一个控诉书(indictment)来提交一个视图变化进入视图v+1，由来自 f + 1 个不同的副本 j 的 <I-HATE-THE-PRIMARY, v><sub>σ<sub>i</sub></sub>和<VIEW-CHANGE, v+1, CC, O, i><sub>σ<sub>i</sub></sub>组成，发送给所有的副本。CC要么是上一个视图中最近的对一个请求的提交证书，没有提交证书的话就是 f + 1 个VIEW-CONFIRM消息，上述都没有的话就是一个NEW-VIEW消息，O是 i 的自CC中的提交证书以来的有序请求历史。这时候，副本就停止接受当前视图的相关消息，并不再回应客户端直到一个新视图开始。
### VC3. 副本接收 2f + 1 个视图变化消息
**主节点.** 一旦接收到 2f + 1 个VIEW-CHANGE消息，新的主节点 p 构建消息<NEW-VIEW, v+1, P><sub>σ<sub>i</sub></sub>，P是由 2f + 1 个VIEW-CHANGE消息构成的，它定义了视图v+1的初始状态。  
**副本.** 副本开始一个计数器，如果在计时器到时前副本没有从新的主节点收到有效的NEW-VIEW消息，那么副本开启一个视图变化到视图v+2。  
如果视图在收到一个新的视图v+1的视图消息之前提交了变化到视图v+2，那么视图用来自视图v的有序请求们形成它的视图变化消息。新视图的计时器的增长呈指数增长，与失败了的视图号码有关。  
### VC4. 副本收到一个有效的视图变化消息并发送一个确认消息给其他的副本
副本基于收集的 2f + 1 个包含NEW-VIEW消息的视图变化消息，形成新视图的状态。 **最近的有一个相关提交证书的请求(或者过去的新视图消息)在基础历史中是最后一次请求可获得的。提交证书之后由至少 f + 1 视图更改消息排序的最新请求将被接受。** 副本 i 基于NEW-VIEW消息形成了消息<VIEW-CONFIRM, v+1, n, h, i><sub>σ<sub>i</sub></sub>并发送VIEW-CONFIRM消息给所有其他副本。  
当评估NEW-VIEW消息时，来自最近视图的提交证书有高于其他所有的优先权，被 f + 1 个VIEW-CONFIRM消息跟随，并最终一个NEW-VIEW消息有最高的视图号。  
### VC5. 副本接受 2f + 1 个匹配的VIEW-CONFIRM消息并开始接受新视图的请求
一旦接收到 2f + 1 个匹配的VIEW-CONFIRM消息，副本 i 开始新视图v。  
视图确认消息对安全性来说并不是严格需要的，可以从协议中被优化掉，但包含了它们简化了我们安全性证明，通过确认是否有一个正确的副本开始接受新视图v的消息，没有其他正确的副本会在不同的基础历史上接受视图v的消息。这一步让副本考虑确认视图变化，在功能是等价于一个所有请求在新视图中的基础历史的提交证书。


---
**REFERENCES**

[1] Kotla, Ramakrishna . "Zyzzyva: speculative byzantine fault tolerance." Acm Sigops Symposium on Operating Systems Principles ACM, 2007.
